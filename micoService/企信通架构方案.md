#企信通架构方案

---

##目录

* 单体
* 前后端分离
* 微服务 和 DDD
* 技术解决方案
* 参考资料

##单体

我们最传统的做网站`MVC`三层结构.

####优点

开发速度快,技术成本低.试试技术难度小.

####缺点

牵一发动全身.无论修改模板还是后端都会影响到全体.代码需要全部部署.且开发速度无法并行.

####图示

![monolithic](./monolithic.png "monolithic")

##前后端分离

###ajax调用请求方案

类似使用`backbone.js`前端模板mvc,所有调用请求走ajax.

####优点

前后分离,前端可以mock数据,开发速度较快.

####缺点

php先渲染模板,js在渲染.js渲染调用的数据会有部分延迟.

####风险

实施难度和风险不大,适中.但是后期扩展不易.

###前端单独服务层方案

前端单独自己服务层,后端提供接口

####风险

实施难度和风险不大,适中.但是后期扩展不易.

##微服务

微服务就是一些协同工作的小而自治的服务.

####很小,专注于做好一件事

保证代码的内聚性, 单一职责

####自治性

一个微服务就是一个独立的实体.

服务之间均通过网络调用进行通信,从而加强了服务之间的隔离性,避免紧耦合.

####技术的异构性

可以在不同的服务中使用适合该服务的技术.尝试使用一种适合所有场景的标准化技术,会使得所有的场景都无法得到很好的支持.

####弹性

在单块中,如果服务不可用,那么所有的功能都会不可用.

####扩展

单块服务职能作为一个整体进行扩展

####风险

技术实施难度较大,分为2点:

1. 前端部分使用纯js开发,人员难度较大.
2. 微服务需要理解事件驱动,事件源(`核心`).还要会使用消息队列.PHP开发人员不仅需要传统的开发方式,还需要了解在CLI下的多线程,进程的开发思路.
3. 分布式,因为微服务所有业务都拆分成个体.需要需要涉及到分布式一致性的问题(为什么需要`事件源`的概念)

####图示

![microService](./microService.png "microService")

##分析准备工作

####项目管理工具

**`redmine`** 

项目管理工具.

[redmine官网]("https://www.redmine.org/", redmine官网)

[redmine流程规范]("./redmine-rule.md", redmine-rule)

类似工具有:

* `tower`
* `禅道`

####版本控制工具

**`git`**

[代码提交规范]("./git-commit-rule.md", 代码提交规范)

####项目分析和建模

首先明确建模不是一个人一拍脑袋就可以思考出来的.需要借助一些工具或者思考模式.务必要了解`契约式`编程还有`高内聚`和`低耦合`.

**`DDD`(思考模式)**

需要开发人员了解限界上下文的概念.有助于划分框架内的架构层次,也有助于后面划分服务的边界.

**`CRC`(工具)**

CRC卡片.

* 有助于划分服务内的对象
* 有助于划分服务.

**`UML`(四色原型)**

使用四色原型来设计UML.

**`数据库建模`**

了解相关数据库`范式`.

我们建立于满足`BCNF`范式.如果对范式不了解可以查看 [我的文章](https://github.com/chloroplast1983/readingNotes/blob/master/%E6%9D%82%E8%AE%B0/%E6%95%B0%E6%8D%AE%E5%BA%93/%E8%8C%83%E5%BC%8F.md, "我的文章").

##技术解决方案

###CQRS

服务本身只提供命令式模型,然后单独提出一个`search.api.xxx.com`作为`Query`入口.方案待确定`Elastic Search`后在确认.

###API GateWay

需要非`I/O`阻塞型,`node.js`和`rxjs`

**风险**

需要了解node人员和后端人员一起维护开发,此点为同一对外接口提供服务.

**不使用的代价**

如果不使用该接口网关,则会导致服务一次调用过多的接口.没有集中处理.

###接口

`Restful`和`JsonApi(www.jsonapi.org)`

###系统

####`docker`(容器)

`amazon`,`google`都在提供以及该技术的解决方案.

**生产环境部署过**.

####`rancher`(容器编排工具) or `k8s`

#####`rancher`

有容云

比较新型的容器集群企业级方案,优点部署简单方便快速.缺点是比较新.`TW`分享会中也比较推崇该解决方案.

#####`k8s`

google的容器集群部署方案.

优点,社区维护人员多,版本迭代比较快.

缺点,安装维护技术成本较高,使用上是自己的一套编排模板与`docker`不兼容.

**开发环境部署过**

#####个人观点

我个人推崇该方案,因为部署和维护较为简单.相对于`k8s`(我早起接触的)与`docker`的融合性更高,内置监控工具.

使用`k8s`还需要配套的`etcd`,`flannel`等支持.

###后端技术解决方案

* `PHP 7`
	* `生产环境` 
* `pThreads`(php多线程扩展)
	* `--enable-maintainer-zts`
* `pcntl`(进程控制)
	* ` --enable-pcntl ` 暂时还未确定是否需要.	
* `rabbitMq`(队列)
	* `企业消息系统` 
	* 在集群内使用LB出现中断版本为3.5,单独服务器部署为3.5没有出现客户端中断连接情况.后期需要检查排查问题.
* `php cli`(php命令行模式)
* `DDD`(领域驱动建模,是一种设计程序的模式,`领域驱动编程`)
	* `代码编程思想`
* 代码`可读性`较高(命名,英文能力),代码开发符合规范`PSR2`,了解`单元测试`.
* `事件驱动`,`事件源`

**我为什么考虑使用php的多线程**

1. 希望在初期减少语言的覆盖,可以尽量减少技术成本.
2. 使用phpcli 调用内部实现会较为方便,如果使用其他语言,则还需要考虑跨语言调用内部功能实现.

###前后端数据交互

* `REST` 接口风格
* `jsonapi` 接口协议
	* [www.jsonapi.org](http://www.jsonapi.org/, "链接")

###前端技术解决方案

* `暂定`
* `node.js`
	* `Google V8` 
* `react`
	* `facebook`
* `redux`
	* `facebook`

**风险**

这个需要前端人员来确定

1. 因为react 和 redux技术成本较高
2. 如果要尝试使用,最好先学下下前端的工作流 glup,grunt 等

**优点**

1. io非阻塞型
2. 可以和模板统一语言(`js`),传统的模板挂接(假设使用`php`),则需要前端人员修改页面后在交付php开发人员修改页面

###数据库(sql and no-sql)

* `mysql 5.6`
	* `innodb` 
	* `索引设计` 
	* `生产环境`
* `mongodb`
	* `生产环境` 
* `redis`
	* `生产环境`
* `memcached`
	* `生产环境`

###后端框架

* `marmot`(自写框架,针对微服务框架)
	* `生产环境` 

###测试

* `phpunit`(单元测试) 
* `behat`(行为驱动测试,不必须)
	* [behat]("http://docs.behat.org", behat) 
* `针对服务端测试`
* `CDC(Consumer-Driven Contract)` 消费者驱动契约(需要前端后端一起)
* `数据模拟:faker`
	* [faker]("https://github.com/fzaninotto/Faker", faker) 
* 服务的打桩
* 容量测试,暂时还未做过,也没有合适的解决方案.
* 端到端测试
	* 需要前端确定
	* behat + mink
	* unit + Selenium

###自动检测工具

**PHP**

* `phpcs`, code sniffer 自动检测代码符合 PSR2.0
	* `使用过`
* `phpcpd`, 覆盖检测 检测是否有重复代码
	* `使用过`
* `phpmd`, 代码分析
	* `使用过,但是需要额外实现生成可视化结果的工作来和jenkins集成`

###CI/CD

####工具

* `jenkins 2.0`
	* 需要考虑自动化测试是使用jenkins然后`docker in docker`
	* 还是单独使用一台服务器区跑.
* `ansible` 自动化工具

####自动化开发环境

使用`ansible`可以自动化的给服务器创建一个开发环境(前端和后端).不过前端的所有自动化工具,需要前端人员确定后才可以开发.

####CI

* 代码在本机可以自动化运行单元测试,风格检测和重复代码检测.
* 代码提交以后可以自动进行构建流水线

####CD

* 代码自动发布
* 发布的冒烟测试

###搜索

* `sphinx`
	* `生产环境`
* `elastic search` 
	* `?` 
	
比较麻烦
	
###日志

`ELK`

`待定`,这里如果在微服务下需要针对容器做日志收集和分析的工作.

##其他的解决方案

如果考虑微服务实施难度和人员问题,可以考虑从单体过度到微服务.但是这其中就会牵扯到重复开发的问题.
在初期网站以及业务定型后在过度转向微服务.

##需要后续的工作

* 完善框架
* 自动化处理
* elastice search 搜索引擎搭建处理

##参考资料

* [rabbitMq](https://www.rabbitmq.com/, "rabbitMq")
* [microService](http://dockone.io/article/394, "microService")
* [rancher](http://docs.rancher.com, "rancher")
* [docker](http://www.docker.com/, "docker")
* [jenkins](https://jenkins.io/index.html, "jenkins")
* [pthreads](http://pthreads.org/, "pthreads")
* [k8s](http://kubernetes.io/, "k8s")
* [phpunit](http://phpunit.de/, "phpunt")
* [behat](http://behat.org/, "behat")